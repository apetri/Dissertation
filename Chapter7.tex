%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Applications to the LSST survey: systematic challenges}
\lhead[\fancyplain{}{\thepage}]{\fancyplain{}{\rightmark}}
 \thispagestyle{plain}
\setlength{\parindent}{10mm}
\label{chp:7}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this Chapter we discuss some of the systematic challenges that come with a large sky area survey such as LSST \citep{LSST}. In the previous chapter we saw that a small WL survey, such as CFHTLenS, leaves the Dark Energy equation of state $w_0$ essentially unconstrained. LSST covers an area of roughly $12,000\,{\rm deg}^2$, 100 times bigger than CFHTLenS, ideally yielding parameter constraints that are 10 times more precise. This increased precision comes at a cost, because small systematic effects that were negligible for CFHTLenS because of the large statistical errors, may not be negligible anymore when compared to cosmic variance fluctuations that are 10 times smaller. We discuss a variety of systematic effects that can affect parameter estimates: we focus on atmospheric contaminations to the shear signal, sensor effects and inaccuracies in photometric redshift estimation. We also study potential parameter biases that can arise from approximate forward modeling based on the Born approximation. To conclude, we give an overview of additional systematic effects which we did not have the chance to investigate, and that we leave for future work.    

\section{Atmospheric/PSF spurious shear}
\label{sec:7:spurious}
The first systematic issue we are going to investigate has to do with contaminations in the galaxy shape measurements \citep{PetriSpShear}. Before hitting the sensors on the telescope plate, photons travel through the Earth's atmosphere, which dilutes the WL signal by convolving it with a suitable Point Spread Function (PSF). This contamination adds to instrumentation specific issues, such as the telescope PSF, tracking errors and photon shot noise. All these effects are modeled and simulated using the \ttt{phosim} software package \citep{LSSTOperations}. We were provided with 20 independent realizations of a spurious shear catalog (see \citep{ChangLSST}) containing $10^5$ galaxies spread over a 4\,deg$^2$ field of view, which were generated with \ttt{phosim}. The catalog contains information about the residual spurious shear after PSF corrections with polynomial fits were attempted \citep{ChangLSST}. The stochastic component of this residual spurious shear decreases approximately as the inverse of the number of exposures of a single field of view. The spatial patterns of the residuals in 4 of these realizations are shown in Figure \ref{fig:7:spvisualize}. 
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.4]{Figures/eps/spurious_visualize.eps}
\end{center}
\caption{4 independent realizations of the residual spurious $\kappa$ after subtractions performed with polynomial fits to the PSF \citep{ChangLSST}. We show the reconstructed $\kappa$ profiles obtained via the KS inversion procedure in (\ref{eq:2:kappa-ks}). A Gaussian smoothing kernel with scale $\theta_G=1'$ has been applied to the images.}
\label{fig:7:spvisualize}
\end{figure}
%
Spatial correlations in the patterns seen in Figure \ref{fig:7:spvisualize} can be quantified in terms of the shear--shear two point correlation function
\begin{equation}
\label{eq:7:shear2pt}
\xi_{\gamma\gamma}^+(\alpha) = \left\langle\gamma^1(\pt)\gamma^1(\pt+\palpha)+\gamma^2(\pt)\gamma^2(\pt+\palpha)\right\rangle
\end{equation} 
%
which is related to the spurious shear $E$ and $B$ mode power spectra as 
\begin{equation}
\label{eq:7:shearPow}
\xi_{\gamma\gamma}^+(\alpha) = \int_0^\infty \frac{d\ell}{2\pi}\ell J_0(\ell\alpha)[S^{EE}(\ell)+S^{BB}(\ell)] 
\end{equation}
%
Where $S^{EE}, S^{BB}$ are the power spectra of the $E$ and $B$ modes of the spurious shear, defined in equation (\ref{eq:2:shear-eb}). $J_0$ refers to the 0--th order Bessel function of the first kind. A useful number to quote is the amplitude $\sigma_{\kappa,{\rm sp}}$ of the $\kappa$ contamination induced by this spurious shear, defined by
\begin{equation}
\label{eq:7:sigmasys}
\sigma^2_{\kappa,{\rm sp}} = \int_0^\infty \frac{d\ell}{2\pi}\ell S^{EE}(\ell) 
\end{equation}
%
As we can see from Figure \ref{fig:7:eb2d}, we are allowed to use the statistical isotropy assumption for this kind of spurious shear, as its power spectrum depends on $\ell=\vert\pell\vert$ only
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.75]{Figures/eps/spurious_eb2D.eps}
\end{center}
\caption{Two dimensional profiles of the power spectra measured from the spurious shear $E$ (left panel) and $B$ (middle panel) modes. We also measure the cross $EB$ term $\langle\tilde{\gamma}^E\tilde{\gamma}^B\rangle$ (right panel). The quantities shown refer to the average among the 20 independent residual spurious shear realizations. The statistical isotropy of the patterns is evident, as well as the fact that $S^{EE}$ and $S^{BB}$, unlike the case for the WL signal, are comparable in magnitude.}
\label{fig:7:eb2d}
\end{figure} 
%
A popular model for the scale dependence of the residual spurious shear power spectrum \citep{AmaraSP} is a log--linear one
\begin{equation}
\label{eq:7:loglin}
S^{EE}(\ell) = \frac{A}{\ell(\ell+1)}\left\vert1+n\log\left(\frac{\ell}{\ell_0}\right)\right\vert
\end{equation}
%
where $A,n,\ell_0$ refer to the spurious signal amplitude, spectral index and multipole pivot point respectively. Such a model has been employed by \citep{AmaraSP} in order to forecast parameter biases caused by uncorrected spurious shear. Using the 20 spurious shear realizations we were provided with, we found that the log--linear model (\ref{eq:7:loglin}) for the residual spurious shear is only correct for small $\ell$, but breaks down at larger multipoles \citep{PetriSpShear}, as can be seen in Figure \ref{fig:7:spfit}. 
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/eps/spurious_fit.eps}
\end{center}
\caption{$\ell$ dependence of the residual spurious shear power spectra $S^{EE}$ (blue), $S^{BB}$ (green) and $S^{EB}$ (red). The mid points and error bars refer respectively to the mean and standard deviation of the power spectra measured from the 20 spurious shear realizations. The dashed black line shows the best fit to the $EE$ power spectrum performed with the empirical model in equation (\ref{eq:7:empmodel}).}
\label{fig:7:spfit}
\end{figure} 
%
We propose the following alternative model for the spurious shear power spectrum. The model is piecewise log--linear but has an exponential damping at high $\ell$, and provides a better fit to the instrument simulation than (\ref{eq:7:loglin}). We used the following empirical approximation

\begin{equation}
\label{eq:7:empmodel}
S^{EE}(\ell) = 
\begin{cases}
\frac{A_0}{\ell(\ell+1)}\left\vert1+n_0\log\left(\frac{\ell}{\ell_0}\right)\right\vert \,\,\,\,  {\rm if } \,\,\,\, \ell\leq 700 \\
\frac{A_1}{\ell(\ell+1)}\left\vert1+n_1\log\left(\frac{\ell}{\ell_0}\right)\right\vert \,\,\,\,  {\rm if } \,\,\,\, 700\leq\ell\leq 3300 \\
\frac{A_2\log{\ell}}{\ell(\ell+1)}\exp\left[-b(\log{\ell}-\mu)^2\right] \,\,\,\,  {\rm if } \,\,\,\, \ell > 3300
\end{cases} 
\end{equation}
%
The pivot point has been fixed to $\ell_0=700$ and the best fit parameters to the pattern seen in Figure \ref{fig:7:spfit} have been found to be $(A_0,n_0,A_1,n_1,A_2,b,\mu)=(3.17\cdot 10^{-5},1.36,1.6\cdot 10^{-4},7.54,4.4\cdot 10^{-5},15.37,3.41)$. If we model this residual spurious shear as an additive contamination to the WL shear signal, using equation (\ref{eq:5:linapprox-peak}) we can evaluate the $\Lambda$CDM parameter bias that is induced by leaving this systematic effect uncorrected. In order to properly do this, we generated Gaussian spurious shear $\kappa$ mock images using the empirical model (\ref{eq:7:empmodel}). The Fourier coefficients for the spurious $\kappa$ maps are drawn from a Gaussian distribution with zero mean and variance $S^{EE}(\ell)$. We added these spurious shear mock realizations on top of the WL signal maps, we extracted the image features according to the procedures described in Chapter \ref{chp:4} and we quantified parameter biases on the triplet $(\Omega_m,w_0,\sigma_8)$. The results are shown in Table \ref{tab:7:spbias}.
%
\begin{table}
\begin{center}
\begin{tabular}{c|ccc} 
\multicolumn{4}{c}{\textbf{Survey Assumptions}} \\
\multicolumn{4}{c}{$z_s=2$, $n_g=15\,{\rm galaxies/arcmin}^{-2}$, $\ell\in[100,2\cdot10^4]$, $\kappa_{\rm MF}\in[-2\sigma,2\sigma]$, $\kappa_{\rm pk}\in[-2\sigma,5\sigma]$} \\ \hline \hline

\textbf{Model} & $\Omega_m$ & $w_0$ & $\sigma_8$  \\ \hline \hline 
&\multicolumn{3}{c}{\textbf{$\kappa$ power spectrum}} \\ 
\textit{Log--linear} & $4.0\cdot 10^{-6}$  & $-2.69\cdot 10^{-4}$ & $2.5\cdot 10^{-5}$ \\
\textit{LSST simulation} &  $-6.22\cdot10^{-5}$ &  $2.94\cdot10^{-4}$ &  $1.32\cdot10^{-4}$ \\
\textit{LSST simulation} $\times 10$ & $-7.51\cdot10^{-4}$ &  0.0025 &  0.0015 \\ 
\textit{Error} ($1\sigma$) & 0.0015 & 0.01 & 0.0025 \\ \hline \hline

&\multicolumn{3}{c}{\textbf{Minkowski functionals}} \\ 
\textit{Log--linear} & 0.0026 &0.037 & $-0.0024$ \\
\textit{LSST simulation} & 0.0020 &  0.025 & $-0.0014$ \\
\textit{LSST simulation} $\times 10$ & 0.007 & 0.055 & $-0.0068$ \\ 
\textit{Error ($1\sigma$)} & 0.001 &0.005  &0.0014 \\ \hline

&\multicolumn{3}{c}{\textbf{$\kappa$ Moments}} \\ 
\textit{Log--linear} & $-2.8\cdot 10^{-5}$ & $-0.0011$  & $4.7\cdot 10^{-5}$ \\
\textit{LSST simulation} & $1.09\cdot10^{-5}$ & $-3.96\cdot10^{-4}$ & $-7.60\cdot10^{-6}$ \\
\textit{LSST simulation} $\times 10$ & $-2.84\cdot10^{-5}$ & $-4.72\cdot10^{-3}$ &  $1.26\cdot10^{-4}$ \\ 
\textit{Error} ($1\sigma$) & 0.0016 &0.008  & 0.002  \\ \hline \hline

&\multicolumn{3}{c}{\textbf{Peak counts}} \\ 
\textit{Log--linear} & 0.009 & 0.026 & $3.2\cdot 10^{-4}$ \\
\textit{LSST simulation} & 0.0011 &  0.018 &  $2.9\cdot10^{-4}$ \\
\textit{LSST simulation} $\times 10$ & 0.0026 & 0.046 & $4.0\cdot10^{-4}$ \\ 
\textit{Error} ($1\sigma$) & 0.0011  & 0.0062  & 0.0015 \\ \hline \hline

\end{tabular}
\end{center}

\caption{Comparison for the bias values on the parameter triplet $(\Omega_m,w_0,\sigma_8)$ using three different models for the LSST spurious shear: \textit{Log--linear} (first rows) refers to the log--linear model (\ref{eq:7:loglin}) with $(A,n,l_0)=(10^{-6.6},0.7,700)$, with the normalization $\sigma^2_{\kappa,{\rm sp}}=4\times10^{-7}$. \textit{LSST simulation} (second rows) refers to the spurious shear mocks generated with the empirical model (\ref{eq:7:empmodel}) (the amplitudes have been divided by a factor of $N_{\rm exposures}=368$ to account for multiple field of view exposures), \textit{LSST simulation $\times$ 10} (third rows) refers to the same model but with the amplitude $\sigma^2_{\kappa,{\rm sp}}$ increased by a factor of 10. The $1\sigma$ error values (fourth rows) refer to the forecasts for an LSST--like survey obtained with equation (\ref{eq:5:linapprox-cov}).}
\label{tab:7:spbias}
\end{table}
%
The results show that, for the simplified control case in which all the source galaxies are placed at the same redshift $z_s=2$, the effect of the spurious shear on parameter constraints depends on the type of feature considered in the analysis. While features that are polynomial in $\kappa$, such as the power spectrum and moments, can deliver constraints which are essentially unbiased for the study cases described in Table \ref{tab:7:spbias}, the same is not true for features that probe the morphology of $\kappa$. Minkowski functionals deliver constraints which suffer from a bias of several $\sigma$, when spurious shear corrections are ignored. The situation is not as dramatic for the peak counts constraint on $\sigma_8$, as the significance of the bias is below $1\sigma$. When we look at the $\Omega_m$ and $w_0$ constraints, however, the bias can be as large as $2\sigma$ for the spurious shear modeled by the LSST instrument simulation. Because different features bias the constraints in different directions in parameter space, possibilities of self--calibration for this kind of contamination could be considered in the future.

\section{CCD sensor effects}
\label{sec:7:ccd}
In this section we discuss some of the systematic issues that can arise from imperfections in the sensors used to image source galaxies. Modern telescopes, such as LSST, use Charge--Coupled Devices (CCD) \citep{CCDBook,LSST,LSSTOperations} as a mean to covert photon counts into voltage signals which can then be converted into digitized images. Impurity gradients in the silicon of which CCDs are made lead to the presence of spurious transverse electric fields, which displace the photons captured by the CCD. Such displacements can lead to observed shape distortions, which may have an effect on the reconstructed WL fields. The astrometric displacement $\bb{d}_E$ field due to the transverse electric fields is usually modeled as a two dimensional radial field \citep{PetriCCD} on the surface of the CCD

\begin{equation}
\label{eq:7:displ}
\bb{d}_E = d(r)\bbh{r}
\end{equation}
%
which, at first order, causes an additive spurious contribution to the reconstructed $\kappa$ field, which takes the name of \textit{tree ring} effect. The additive spurious convergence $\kappa_{\rm tree}$ can be calculated as (see \citep{PetriCCD})

\begin{equation}
\label{eq:7:ktree}
\kappa_{\rm tree} = -\frac{1}{2}\nabla\cdot\bb{d}_E = -\frac{1}{2}\left(\frac{d(r)}{r}+\frac{d}{dr}d(r)\right)
\end{equation}   
%
A visualization of the spurious convergence induced by the tree ring effect is shown in the left panel of Figure \ref{fig:7:sensvis}. 
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.4]{Figures/eps/sensors_visualize.eps}
\end{center}
\caption{Spatial profiles of the additive contaminations to $\kappa$ due to the tree ring (left) and pixel size variations (right) effects. The maps cover a field of view of $(0.2\,{\rm deg})^2$. In order to extend the systematic effects mapping to the entire LSST field of view of $(3.5\,{\rm deg})^2$, we repeated the patterns seen in this Figure across the whole field of view, applying random $90^\circ$ rotations.}
\label{fig:7:sensvis}
\end{figure}
%
An additional source of contamination that derives from CCD manufacture imperfections has to do with variable pixel sizes. When the pixel area is not uniform across the CCD surface, variations in photon counts can be erroneously interpreted as variations in the source intensity profile. This creates a possible additional source of error in the measurement of galaxy shapes. A realistic spatial profile of the additive contribution to $\kappa$ caused by pixel size variations, which we call $\kappa_{\rm pixel}$, is shown in the right panel of Figure \ref{fig:7:sensvis}. For a more throughout discussion and treatment of the tree ring and pixel size variation effects we remand the reader to \citep{PetriCCD}. In order to evaluate the effect of the tree ring and pixel size variation systematics on cosmological constraints, we make use of equation (\ref{eq:5:linapprox-peak}) and we use the $\kappa$ power spectrum $P_{\kappa\kappa}$ as an image feature. The bias estimate $\bbh{b}$ in the parameters is calculated as 

\begin{equation}
\label{eq:7:biasccd}
\bbh{b} = \bbh{p}_{\rm sp}-\bbh{p}_0 = \bb{Z}(\bbh{d}_{\rm sp}-\bbh{d}_0)
\end{equation}
%
Where we indicated as $\bbh{d}_{\rm sp},\bbh{d}_0$ the measured $\kappa$ power spectra with and without CCD systematics present. The $N_\pi\times N_d$ projection matrix $\bb{Z}$ is defined as 

\begin{equation}
\label{eq:7:zeta}
\bb{Z} = (\bb{M}^T\bb{\Psi}\bb{M})^{-1}\bb{M}^T\bb{\Psi}
\end{equation}
%
following the notation of \S~\ref{sec:5:fisher}, in which $\bb{M},\bb{\Psi}$ refer to the feature cosmology derivative and inverse covariance matrix respectively. More explicitly, we can write the power spectrum difference as 

\begin{equation}
\label{eq:7:powerccd}
\h{P}_{\kappa\kappa+{\rm sp}}(\ell_b)-\h{P}_{\kappa\kappa}(\ell_b) = \left\vert\frac{\h{\tilde{\kappa}}(\ell_b)+\tilde{\kappa}_{\rm sp}(\ell_b)}{2\pi}\right\vert^2-\h{P}_{\kappa\kappa}(\ell_b) 
\end{equation} 
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/eps/sensors_power.eps}
\end{center}
\caption{Power spectrum of the additive $\kappa$ contamination due to the tree ring (blue) and pixel size variation (green) effects. The power spectra were measured from one realization of a $(3.5\,{\rm deg})^2$ field of view obtained repeating the patterns in Figure \ref{fig:7:sensvis} with random $90^\circ$ rotations.}
\label{fig:7:ccdpow}
\end{figure}
%
In equation (\ref{eq:7:powerccd}) the subscript $i$ can either refer to the tree ring or pixel variation effect. Note that, contrary to $\h{\tilde{\kappa}}$, the systematic additive contribution $\tilde{\kappa}_{\rm sp}$ is not a stochastic quantity, since it is tied to the field of view. The same is true for its angular power spectrum $P_{\kappa\kappa,{\rm sp}}$ (shown in Figure \ref{fig:7:ccdpow}). We can write the bias estimator for the $\alpha$--th cosmological parameter as 
\begin{equation}
\label{eq:7:biasccd-1}
\h{b}_\alpha = \sum_{\ell_b=\ell_{\rm min}}^{\ell_{\rm max}} Z_{\alpha\ell_b}\left(P_{\kappa\kappa,{\rm sp}}(\ell_b)+\frac{\h{\tilde{\kappa}}(\ell_b)\tilde{\kappa}_{\rm sp}^*(\ell_b)+\h{\tilde{\kappa}}^*(\ell_b)\tilde{\kappa}_{\rm sp}(\ell_b)}{(2\pi)^2}\right)
\end{equation}
%
We assume a diagonal covariance matrix for the $\kappa$ power spectrum, calculated according to (\ref{eq:4:powercov-gauss-bin}) 

\begin{equation}
\label{eq:7:diagcov}
C_{\ell_b\ell_{b'}} = \frac{P^2_{\kappa\kappa}(\ell_b)}{N_{\rm modes}(\ell_b)}\delta_{\ell_b\ell_{b'}}
\end{equation}
%
where $N_{\rm modes}(\ell_b)$ is the number of $\pell$ modes that fall inside the multipole bin $\ell_b$, and can be read off equation (\ref{eq:4:powercov-gauss-bin}). With this assumption, we can write down the expectation value $\bb{b}$ and scatter $\sigma_{\bb{b}}$ for the bias estimator (\ref{eq:7:biasccd-1}) as  

\begin{equation}
\label{eq:7:expb}
b_\alpha = \left\langle\h{b}_\alpha\right\rangle = \sum_{\ell_b=\ell_{\rm min}}^{\ell_{\rm max}} Z_{\alpha\ell_b}P_{\rm sp}(\ell_b)
\end{equation}
%
\begin{equation}
\label{eq:7:sigmab}
\sigma_{b_\alpha} = \sqrt{\left\langle\left(\h{b}_\alpha-b_\alpha\right)^2\right\rangle} = 2\sum_{\ell_b=\ell_{\rm min}}^{\ell_{\rm max}} Z_{\alpha\ell_b}\sqrt{\frac{P_{\rm sp}(\ell_b)P_{\kappa\kappa}(\ell_b)}{N_{\rm modes}(\ell_b)}}
\end{equation}
%
Note that, because of the nature of the bias estimator (\ref{eq:7:biasccd-1}), the CCD induced parameter bias has both a fixed component (\ref{eq:7:expb}) proportional to $P_{\rm sp}$ and a stochastic component with a root mean square error (\ref{eq:7:sigmab}) that scales as $\sqrt{P_{\rm sp}/N_{\rm modes}}$. Depending on the size of the survey, the fixed and stochastic components of the parameter bias can have different relative amplitudes because, while (\ref{eq:7:sigmab}) decreases with the survey area, (\ref{eq:7:expb}) does not.
%
\begin{table}
\begin{center}
\begin{tabular}{c|ccc}
\textbf{Bias component} & $\Omega_m$ & $w_0$ & $\sigma_8$ \\ \hline \hline
\multicolumn{4}{c}{\textbf{Tree rings}} \\ \hline
$\bb{b}$ & $5.05\cdot 10^{-10}$ & $2.79\cdot 10^{-9}$ & $-3.52\cdot 10^{-10}$ \\
$\sigma_{\bb{b}}$ & $6.92\cdot 10^{-8}$ & $1.34\cdot 10^{-7}$ & $1.29\cdot 10^{-7}$ \\ \hline

\multicolumn{4}{c}{\textbf{Pixel size variations}} \\ \hline
$\bb{b}$ & $1.21\cdot 10^{-5}$ & $-2.18\cdot 10^{-5}$ & $-1.79\cdot 10^{-5}$ \\
$\sigma_{\bb{b}}$ & $1.21\cdot 10^{-5}$ & $3.37\cdot 10^{-5}$ & $1.82\cdot 10^{-5}$ \\ \hline
\end{tabular}
\end{center}
\caption{Amplitudes for the fixed (\ref{eq:7:expb}) and stochastic (\ref{eq:7:sigmab}) components of the $(\Omega_m,w_0,\sigma_8)$ bias induced by the tree ring and pixel size variations effects resulting from CCD fabrication imperfections. The spurious contributions to $\kappa$ were measured from a LSST instrument simulation \citep{PetriCCD}, and the forward models necessary to obtain the WL $P_{\kappa\kappa}$ derivatives $\bb{M}$ and covariance matrix $\bb{C}$ were calculated with the analytical code $\ttt{NICAEA}$ \citep{Nicaea}. The number $N_{\rm modes}$ of $\pell$ modes which appears in equation (\ref{eq:7:sigmab}) is referred to an LSST--like survey. Shape noise contributions with a galaxy density of $n_g=15\,{\rm galaxies/arcmin^2}$ are included.}
\label{tab:7:ccdbias}
\end{table}
%
Table \ref{tab:7:ccdbias} shows the values for the amplitude of the bias components $\bb{b},\sigma_{\bb{b}}$ for an LSST--like galaxy survey. Compared with the $1\sigma$ $\Lambda$CDM parameter errors shown in Table \ref{tab:7:spbias}, we can conclude that the biases induced by the CCD imperfections considered in this section can be safely neglected even for a survey with an area as wide as LSST, because they are several order of magnitude smaller than the parameter uncertainty due to cosmic variance.  

\section{Photometric redshift errors}
\label{sec:7:photoz}
In this section we examine the effects of uncorrected redshift measurement errors on $\Lambda$CDM parameter constraints. Photometric surveys such as LSST do not use full spectroscopic information in order to determine the redshift $z_s$ of a source, but use the information on a limited number of frequency bands (LSST uses 5 of them for example) in order to estimate $z_s$. This can lead to redshift measurement inaccuracies if the measured redshift $z_{\rm ph}$ is not an unbiased estimate of $z_s$. We model the relation between the photometric and real redshift of a source galaxy as the sum of a fixed bias $b_{\rm ph}$ and a stochastic component of root mean square $\sigma_{\rm ph}$ \citep{PetriPhotoZ,LSSTSciBook} 

\begin{equation}
\label{eq:7:phreal}
z_{\rm ph}(z_s) = z_s + b_{\rm ph}(z_s) + \sigma_{\rm ph}(z_s)\mathcal{N}(0,1)
\end{equation}
%
where we chose the functional forms of the bias and root mean square following the LSST Science Book \citep{LSSTSciBook} as 

\begin{equation}
\label{eq:7:bph}
b_{\rm ph}(z_s) = 0.003(1+z_s)
\end{equation}
%
\begin{equation}
\label{eq:7:sph}
\sigma_{\rm ph}(z_s) = 0.02(1+z_s)
\end{equation}
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/png/lsst_galdistr.png}
\end{center}
\caption{Redshift distribution of $10^6$ source galaxies arranged uniformly in a $(3.5\,{\rm deg})^2$ field of view (which corresponds to a density of $n_g=22\,{\rm galaxies/arcmin}^2$). The distribution follows the law $n(z_s)\propto (z_s/z_0)^2\exp(-z_s/z_0)$ with $z_0=0.3$. For the purpose of this study the galaxies have been divided in 5 redshift bins which have been chosen such that each bin contains the same number of galaxies.}
\label{fig:7:galdistr}
\end{figure}
%
We simulated an LSST--like galaxy survey by drawing the redshift $z_s$ of $N_g=10^6$ source galaxies from the distribution in Figure \ref{fig:7:galdistr}. The galaxies are distributed uniformly in a $(3.5\,{\rm deg})^2$ field of view. Uncorrected photometric redshift systematics can lead to biased constraints when employing redshift tomography for a more throughout mapping of the WL feature space \citep{HutererWLSys,PetriPhotoZ}. If we assign the redshift $z_{\rm ph}$ to a galaxy which has a real redshift of $z_s$ during the feature forward modeling process, we must consider the possibility that the resulting $\Lambda$CDM parameter inferences may be biased. 
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.4]{Figures/eps/photoz_bias_Om-w.eps}\includegraphics[scale=0.4]{Figures/eps/photoz_constraints_Om-w_lensing_cmb.eps}
\end{center}
\caption{Left panel: parameter bias on $(\Omega_m,w_0)$ induced by photometric redshift errors, obtained using the $\kappa$ tomographic power spectrum (red), peak counts (green) and moments (blue). We show the results for 20 independent LSST--like survey realizations (crosses) and indicate the mean of $\h{p}^{\rm ph}-\h{p}$ as a square. For reference, we draw the $1\sigma$ (68\% confidence level) ellipses on the bias $\h{p}^{\rm ph}-\h{p}$ assuming its distribution is Gaussian. Right panel: $1\sigma$ confidence ellipses on $(\Omega_m,w_0)$ obtained from tomographic features (color coded in the legend). We the constraints without (thin lines) and with (thick lines) Planck \citep{Planck15} priors included via equation (\ref{eq:5:linapprox-cov-prior}). Feature covariance matrices have been measured from $N_r=16,000$ realizations of the shear catalogs.}
\label{fig:7:photoz}
\end{figure}
%
To study the magnitude of this effect, we divide the source galaxies in $N_z=5$ redshift bins and we use the \LT\,functionality to perform ray--tracing to the real redshift $z_s$ of each galaxy. This operation yields a WL shear catalog, which can be produced in multiple different statistical realizations (following the procedure in \S~\ref{sec:3:sampling}) for different $\Lambda$CDM cosmologies. The shear catalogs are then converted in $\kappa$ images via a grid procedure defined by

\begin{equation}
\label{eq:7:gridding}
\pmb{\gamma}(\pt_p,\bar{z}_b) = \frac{\sum_{g=1}^{N_g}\pmb{\gamma}(\pt_g,z_g)W(\pt_g,\pt_p;z_g,\bar{z}_b)}{\sum_{g=1}^{N_g}W(\pt_g,\pt_p;z_g,\bar{z}_b)}
\end{equation}  
%
where $\pt_g,z_g$ refer to the galaxy position and redshift respectively and $\pt_p,\bar{z}_b$ indicate the pixel position on the image grid and the center of the redshift bin (see Figure \ref{fig:7:galdistr}). The window function $W$ has been chosen as a top--hat 

\begin{equation}
\label{eq:7:that}
W(\pt_g,\pt_p;z_g,\bar{z}_b) = 
\begin{cases}
1 \,\,\,\, {\rm if} \,\,\,\, \pt_g\in\pt_p,z_g\in\bar{z}_b \\
0 \,\,\,\, {\rm otherwise}
\end{cases}
\end{equation}
%
The KS inversion procedure (\ref{eq:2:kappa-ks}) is then applied to each of the 5 $\pmb{\gamma}(\pt_p,\bar{z}_b)$ images to obtain the pixelized convergence field  $\kappa(\pt_p,\bar{z}_b)$ (a smoothing factor of $e^{-\ell^2\theta_G^2/2}$ with $\theta_G=0.5'$ has been applied during the KS procedure for convenience). We then proceed with the feature extraction described in Chapter \ref{chp:4}, with the additional possibility of considering tomographic information from the classification of the source galaxies in different redshift bins $\{\bar{z}_b\}$. We can define a cross redshift $\kappa$ power spectrum $P_{\kappa\kappa}(\ell,\bar{z}_b,\bar{z}_{b'})$ as 

\begin{equation}
\label{eq:7:crosspower}
\left\langle\tilde{\kappa}(\pell,\bar{z}_b)\tilde{\kappa}(\pell',\bar{z}_{b'})\right\rangle = (2\pi)^2\delta^D(\pell+\pell')P_{\kappa\kappa}(\ell,\bar{z}_b,\bar{z}_{b'})
\end{equation} 
%
Note that, when introducing tomography, the dimensionality of the feature space defined by $P_{\kappa\kappa}$ increases from $N_d$ to $N_d N_z(N_z-1)/2$. For the remaining $\kappa$ features described in Chapter \ref{chp:4}, which are not quadratic in $\kappa$, we simply stack together the feature vectors $\bb{d}$ measured in different bins $\bar{z}_b$, increasing the dimensionality of the feature space from $N_d$ to $N_dN_z$. Dimensionality reduction techniques become especially relevant when considering tomographic features because, given the increase in feature space dimensionality, the constraint degradation pitfalls described in \S~\ref{sec:5:degrade} may become important. In order to study the effect of photometric redshift errors, we take the simulated shear catalogs in the fiducial cosmology and we replace each redshift $z_s$ with an estimate $z_{\rm ph}$ based on photometry, which we obtain using equation (\ref{eq:7:phreal}). We then perform the $\kappa$ reconstruction with equation (\ref{eq:7:gridding}), measure the image features and finally infer $\Lambda$CDM parameters using equations (\ref{eq:5:linapprox-peak}), (\ref{eq:5:linapprox-cov}). We quantify the bias induced on the inference of a parameter $p$ by uncorrected photometric redshift systematics as $\h{p}^{\rm ph}-\h{p}$, where $\h{p}^{\rm ph},\h{p}$ are the $p$ estimates from mock observations with and without redshift errors. We show the results in Figure \ref{fig:7:photoz}. 

The results show that photometric redshift errors can cause significant parameter constraints if left uncorrected when using polynomial features such as the power spectrum and the moments of $\kappa$. Peak counts, on the other hand, seem to be less affected by this systematic effect, probably because they probe correlations of galaxy shapes that are very close to each other on the sky. These correlations are affected to a lesser extent by photometric redshift errors, which are spatially uncorrelated. Since the bias for different features appears in different directions in feature space, the possibility of self--calibration may be considered in the future.

The right panel of Figure \ref{fig:7:photoz} shows constraint forecasts on $\Omega_m$ and $w_0$ using tomographic features. The Figure shows that the combination of power spectrum, moments and peaks can in principle constrain $w_0$ to a percent level.   

\section{Born approximation}
\label{sec:7:born}
While in the previous sections we focused on $\Lambda$CDM parameter biases arising from observational systematic effects, in this section we focus on a  potential source of bias due to approximate theoretical modeling of WL features, namely the Born approximation. If one is interested in approximating the forward--modeled $\kappa$ field at first order in the gravitational potential $\Phi$, equation (\ref{eq:3:kappa-fo-num-2}) gives a computationally efficient recipe to do so. The reason why the Born approximation is faster than exact ray--tracing (based on (\ref{eq:3:jackp1-delta})), is that knowledge of the density contrast $\delta$ only is needed. Full ray--tracing, on the other hand, needs the specification of $\Phi$ in order to compute the angle deflections and hence requires the solution to the Poisson equation (\ref{eq:3:poisson-psi-2}). 
%
\begin{table}
\begin{center}
\begin{tabular}{c|c|c|c}
\textbf{Solver} & \textbf{Runtime (1 FOV)} & \textbf{Memory usage} & \textbf{CPU time (1000 FOV)} \\ \hline \hline
Born & 36.0\,s & 0.86\,GB & 10\,hours  \\
Full ray--tracing & 124.8\,s & 1.65\,GB & 35\,hours  \\
Born + $O(\Phi^2)$ & 156.7\,s & 1.52\,GB & 44\,hours \\ \hline
\end{tabular}
\end{center}
\caption{CPU time and memory usage benchmarks for $\kappa$ reconstruction. The test case we considered consists in a discretization with $N_l=42$ uniformly spaced lenses between the observer and the sources at $z_s=2$, each with a resolution of $4096^2$ pixels. The $\kappa$ field is resolved with $2048^2$ light rays. We show both the runtime for producing a single field of view and the CPU hours needed to perform the reconstruction 1000 times, to mock an LSST--like galaxy survey. Run times do not include the Poisson solution calculation, as this can be recycled to produce multiple field of view realizations (see \S~\ref{sec:3:sampling}). The Poisson solution run time is negligible in the account of the total CPU time needed for the production of $N_r\gg N_l$ field of view realizations.}
\label{tab:7:benchmarks}
\end{table}
% 
\begin{figure}
\begin{center}
\includegraphics[scale=0.255]{Figures/eps/bornBias_convergence_powerSN30_s0_nb100.eps}
\includegraphics[scale=0.255]{Figures/eps/bornBias_convergence_momentsSN15_s50_nb9.eps}
\includegraphics[scale=0.255]{Figures/eps/bornBias_convergence_momentsSN30_s50_nb9.eps}
\end{center}
\caption{Distribution of parameter estimates for the triplet $(\Omega_m,w_0,\sigma_8)$, obtained with (\ref{eq:5:linapprox-peak}) for a variety of $\kappa$ features, including the power spectrum and some higher real space moments. The observation to fit has been generated with full ray--tracing and the forward model, based on $\bb{M}$, has been obtained both with the Born approximation (green bars), and exact ray--tracing (for the sake of null testing, blue bars). Forward models and covariance matrices have been estimated from ensembles of 8192 $\kappa$ realizations, and the mock observations have been generated averaging over 1000 realizations, to mimic the area of an LSST--like survey. The $\bbh{p}_0$ samples have been drawn with a bootstrapping procedure over the full ensemble of $\kappa$ realizations.}
\label{fig:7:biasfeat}
\end{figure}
%
\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/eps/bornBias_ngal_convergence_powerSN_s0_nb100.eps}
\end{center}
\caption{Statistical significance of the Born approximation induced bias on the $\Omega_m$(blue), $w_0$(red) and  $\sigma_8$ (green) inference obtained from the $\kappa$ power spectrum, as a function of the survey galaxy angular density $n_g$. The averaged results refer to an ensemble of 1000 bootstrapped realizations of an LSST--like galaxy survey.}
\label{fig:7:biasbornngal}
\end{figure}
%
Table \ref{tab:7:benchmarks} (taken from \citep{PetriBorn}) shows that, using the \LT\,implementation, one can save as much as a factor of 4 in CPU time when computing $\kappa$ using the Born approximation. These time savings, however, come at a price since the forward model (\ref{eq:5:linapprox}) and the matrix $\bb{M}$ will be correct only at $O(\Phi)$. When using approximate forward models to fit observations via (\ref{eq:5:linapprox-peak}), depending on the particular image feature used, one can induce bias in parameter inferences. This possibility was explored in \citep{PetriBorn}, from which we take Figure \ref{fig:7:biasfeat}, which shows the distribution of parameter estimates $\bbh{p}_0$ obtained with exact and Born approximated forward models. We can clearly see that inaccuracies due to the Born approximation do not lead to significantly biased constraints when the $\kappa$ power spectrum is used, as can be seen from the top panel of Figure \ref{fig:7:biasfeat}. This conclusions refers to an LSST like survey with a galaxy density of $30\,{\rm galaxies/arcmin}^2$ and holds for densities as high as $60\,{\rm galaxies/arcmin}^2$, as suggested by Figure \ref{fig:7:biasbornngal}. Figure \ref{fig:7:biasfeat} also shows that, when using $\kappa$ moments to constrain cosmology, the Born approximation is not accurate enough, as the induced bias in $w_0$ and $\sigma_8$ is significant. The bias persists even when Gaussian shape noise is considered because higher $\kappa$ moments are sensitive to the non--Gaussian part of the $\kappa$ field. As seen in \S~\ref{sec:6:omsi8}, $\kappa$ moments contain significant cosmological information. In a WL analysis of a survey with the statistical power of LSST, the Born approximation is not sufficient to correctly predict $\kappa$ higher moments, and an exact approach based on ray--tracing is needed. 

\section{Other systematic effects}
In this section we give a brief overview of a series of systematic effects that we did not consider in this work but might be important for future WL analyses. In \S~\ref{sec:7:ccd} we discussed how CCD imperfections cause spurious contributions to the convergence reconstruction and we isolated two effects, the tree rings and the variations of pixel sizes, that have negligible impact on parameter constraints. There is another effect which influences CCD operations and is worth mentioning: the so called \textit{brighter--fatter} effect \citep{BrightFat}. CCD sensors respond in a non--linear fashion to the flux of source galaxies: charge accumulation on the CCD surface induces artificial image distortions which have a net effect on the $\kappa$ reconstruction procedure. These artificial deformations increase with the flux of the source.

Another systematic effect worth mentioning has to do with the way one interprets correlation in the shapes of nearby galaxies: $\kappa$ is reconstructed via the KS inversion procedure (\ref{eq:2:kappa-ks}) under the assumption that the source of the galaxies ellipticity is cosmic shear. In order to take intrinsic galaxy ellipticity into account one can add a white noise component to $\kappa$ using equation (\ref{eq:2:shapenoise}). This treatment, however, completely ignores the fact that galaxy tend to align with the Large Scale Structure of the universe, and hence their shapes present an \textit{intrinsic alignment} (see \citep{IAReview} for a review on the effect). This alignment is usually modeled in term of an additive component $\pmb{\gamma}^I$ to the shear which, contrary to shape noise, presents spatial correlations. Analytical models for $\pmb{\gamma}^I$ based on the tidal gravitational field have been explored in the literature \citep{IATidal}. The effect of ignoring intrinsic alignment on $\Lambda$CDM inferences using power spectra has also been explored \citep{IABias} and has been proven to be non negligible for large surveys such as LSST, hence requiring the study of mitigation schemes. 

The last systematic worth mentioning in this context has to do with baryonic effects: our $\kappa$ forward modeling pipeline so far relies on Dark Matter only $N$--body simulations, which are relatively straightforward to run due to the collision--less physics that controls Dark Matter particles. In the real universe, however, baryons with non zero pressure play a vital role on small scales. A variety of authors have studied the effects of baryon physics on matter power spectra \citep{BaryonsZentner1,BaryonsZentner2}, WL power spectra \citep{BaryonsWhite,BaryonsKnox}, two and three--point shear statistics \citep{BaryonSemboloni} and WL peak counts \citep{BaryonXiuyuan}. WL forward modeling pipelines that include baryons add additional computational complexity to the $N$--body stage, as hydrodynamic approaches need do be adopted in order to model pressure effects correctly. Additional effects due to AGN and Supernovae feedback are still under theoretical study and pose new challenges.      

%\bibliography{ref}